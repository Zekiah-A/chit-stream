"use strict";var __assign=this&&this.__assign||Object.assign||function(e){for(var t,a=1,r=arguments.length;a<r;a++)for(var n in t=arguments[a])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e};Object.defineProperty(exports,"__esModule",{value:!0});var GPUText=function(){function e(){}return e.layout=function(e,t,a){for(var r=__assign({glyphScale:1,kerningEnabled:!0,ligaturesEnabled:!0,lineHeight:1},a),n=new Array(e.length),l=0,s={l:0,r:0,t:0,b:0},c=0,o=0,i=0;i<e.length;i++){var g=e[i],h=e.charCodeAt(i);switch(h){case 160:case"\n".charCodeAt(0):o+=r.lineHeight,c=0;continue}if(r.ligaturesEnabled,r.kerningEnabled&&0<i){var u=e[i-1]+g;c+=t.kerning[u]||0}var y=t.characters[g];null!=y?(null!=y.glyph&&(n[l++]={char:g,x:c,y:o},s.r=Math.max(s.r,c+y.advance),s.b=Math.max(s.b,o+r.lineHeight)),c+=y.advance):console.warn('Font does not contain character for "'+g+'" ('+h+")")}return n.length>l&&(n.length=l),{font:t,sequence:n,bounds:s,glyphScale:r.glyphScale}},e.generateVertexData=function(e){for(var t=new Float32Array(6*e.sequence.length*5),a=0,r=0;r<e.sequence.length;r++){var n=e.sequence[r],l=e.font,s=l.characters[n.char];if(null!=s&&null!=s.glyph){var c=s.glyph,o=n.x-c.offset.x,i=-(n.y+l.ascender+c.offset.y),g=c.atlasRect.w/c.atlasScale,h=c.atlasRect.h/c.atlasScale,u=(c.atlasRect.x+.5)/l.textureSize.w,y=(c.atlasRect.y+.5)/l.textureSize.h,d=(c.atlasRect.w-1)/l.textureSize.w,f=(c.atlasRect.h-1)/l.textureSize.h;y+=f,f=-f,t.set([o,i,u,y,c.atlasScale,o+g,i+h,u+d,y+f,c.atlasScale,o,i+h,u,y+f,c.atlasScale,o,i,u,y,c.atlasScale,o+g,i,u+d,y,c.atlasScale,o+g,i+h,u+d,y+f,c.atlasScale],5*a),a+=6}}return{vertexArray:t,elementsPerVertex:5,vertexCount:a,vertexLayout:{position:{elements:2,elementSizeBytes:4,strideBytes:20,offsetBytes:0},uv:{elements:3,elementSizeBytes:4,strideBytes:20,offsetBytes:8}}}},e.parse=function(e){for(var t=new DataView(e),a="",r=0;r<e.byteLength;r++){var n=t.getInt8(r);if(0===n)break;a+=String.fromCharCode(n)}for(var l=r+1,s=!0,c=JSON.parse(a),o={format:c.format,version:c.version,technique:c.technique,ascender:c.ascender,descender:c.descender,typoAscender:c.typoAscender,typoDescender:c.typoDescender,lowercaseHeight:c.lowercaseHeight,metadata:c.metadata,fieldRange_px:c.fieldRange_px,characters:{},kerning:{},glyphBounds:void 0,textures:[],textureSize:c.textureSize},i=new DataView(e,l+c.characters.start,c.characters.length),g=0;g<c.charList.length;g++){var h=c.charList[g],u=24*g,y={atlasRect:{x:i.getUint16(u+4,s),y:i.getUint16(u+6,s),w:i.getUint16(u+8,s),h:i.getUint16(u+10,s)},atlasScale:i.getFloat32(u+12,s),offset:{x:i.getFloat32(u+16,s),y:i.getFloat32(u+20,s)}},d=0===y.atlasRect.w||0===y.atlasRect.h,f={advance:i.getFloat32(u+0,s),glyph:d?void 0:y};o.characters[h]=f}var v=new DataView(e,l+c.kerning.start,c.kerning.length);for(g=0;g<c.kerningPairs.length;g++){var p=c.kerningPairs[g],x=v.getFloat32(4*g,s);o.kerning[p]=x}if(null!=c.glyphBounds){o.glyphBounds={};var w=new DataView(e,l+c.glyphBounds.start,c.glyphBounds.length);for(g=0;g<c.charList.length;g++){h=c.charList[g],u=16*g;var S={t:w.getFloat32(u+0,s),r:w.getFloat32(u+4,s),b:w.getFloat32(u+8,s),l:w.getFloat32(u+12,s)};o.glyphBounds[h]=S}}for(var b=0;b<c.textures.length;b++){var B=c.textures[b];o.textures[b]=[];for(var m=0;m<B.length;m++){var R=B[m];if(null!=R.payloadBytes){var F=new Uint8Array(e,l+R.payloadBytes.start,R.payloadBytes.length),k=new Blob([F],{type:"image/png"}),P=new Image;P.src=URL.createObjectURL(k),o.textures[b][m]=P}else null!=R.localPath&&(o.textures[b][m]={localPath:R.localPath})}}return o},e}();exports.default=GPUText;